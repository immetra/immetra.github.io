<!DOCTYPE html>
<html>

<head>
    <!-- Standard Meta -->
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

    <!-- Site Properties -->
    <title>Daily Business Done Processor</title>

    <link rel="stylesheet" type="text/css"
        href="https://cdnjs.cloudflare.com/ajax/libs/fomantic-ui/2.8.4/components/reset.min.css">
    <link rel="stylesheet" type="text/css"
        href="https://cdnjs.cloudflare.com/ajax/libs/fomantic-ui/2.8.4/components/site.min.css">
    <link rel="stylesheet" type="text/css"
        href="https://cdnjs.cloudflare.com/ajax/libs/fomantic-ui/2.8.4/components/container.min.css">
    <link rel="stylesheet" type="text/css"
        href="https://cdnjs.cloudflare.com/ajax/libs/fomantic-ui/2.8.4/components/grid.min.css">
    <link rel="stylesheet" type="text/css"
        href="https://cdnjs.cloudflare.com/ajax/libs/fomantic-ui/2.8.4/components/header.min.css">
    <link rel="stylesheet" type="text/css"
        href="https://cdnjs.cloudflare.com/ajax/libs/fomantic-ui/2.8.4/components/image.min.css">
    <link rel="stylesheet" type="text/css"
        href="https://cdnjs.cloudflare.com/ajax/libs/fomantic-ui/2.8.4/components/form.min.css">
    <link rel="stylesheet" type="text/css"
        href="https://cdnjs.cloudflare.com/ajax/libs/fomantic-ui/2.8.4/components/button.min.css">
    <link rel="stylesheet" type="text/css"
        href="https://cdnjs.cloudflare.com/ajax/libs/fomantic-ui/2.8.4/components/table.min.css">
    <link rel="stylesheet" type="text/css"
        href="https://cdnjs.cloudflare.com/ajax/libs/fomantic-ui/2.8.4/components/divider.min.css">
    <link rel="stylesheet" type="text/css"
        href="https://cdnjs.cloudflare.com/ajax/libs/fomantic-ui/2.8.4/components/list.min.css">
    <link rel="stylesheet" type="text/css"
        href="https://cdnjs.cloudflare.com/ajax/libs/fomantic-ui/2.8.4/components/segment.min.css">
    <link rel="stylesheet" type="text/css"
        href="https://cdnjs.cloudflare.com/ajax/libs/fomantic-ui/2.8.4/components/card.min.css">
    <link rel="stylesheet" type="text/css"
        href="https://cdnjs.cloudflare.com/ajax/libs/fomantic-ui/2.8.4/components/icon.min.css">
    <link rel="stylesheet" type="text/css"
        href="https://cdnjs.cloudflare.com/ajax/libs/fomantic-ui/2.8.4/components/label.min.css">

    <style type="text/css">
        body {
            background-color: #FFFFFF;
            padding-top: 30px;
        }

        #result-container {
            min-height: 300px;
            padding: 20px 0;
        }

        .pos-stock-name {
            margin-top: -20px;
        }

        .ui.footer.segment {
            /* margin: 5em 0em 0em;
            padding: 5em 0em; */
        }

        body {
            display: flex;
            min-height: 100vh;
            flex-direction: column;
        }

        body > .main {
            flex: 1;
        }
    </style>

</head>

<body>

    <div class="ui main text container">
        <h1 class="ui header">Daily Business Done Processor</h1>

        <div class="ui one column grid">
            <div class="column">
                <div id="btn-container">
                    <button class="ui left floated primary button" type="button" id="input-btn">Add Input</button>
                    <button class="ui right floated orange button" type="button" id="clear-btn">Clear Data</button>
                    <button class="ui right floated secondary button" type="button" id="export-btn">Export Data</button>
                </div>
                <form class="ui form" id="input-form" style="display:none">
                    <div class="field">
                        <label>Copy all text from the Daily Business Done page and paste them here. You can also paste in previously exported data.</label>
                        <textarea id="input-txt"></textarea>
                    </div>
                    <button class="ui green button" type="button" id="process-btn">Process</button>
                    <button class="ui button" type="button" id="cancel-btn">Cancel</button>
                </form>
        
                <form class="ui form" id="export-form" style="display:none">
                    <div class="field">
                        <label>Copy and paste the content of this box into text file or Excel.</label>
                        <textarea id="export-txt"></textarea>
                    </div>
                    <button class="ui button" type="button" id="export-close-btn">Close</button>
                </form>
            </div>
            <div class="column">
                <form class="ui form">
                    <div class="two fields">
                        <div class="twelve wide field">
                            <div class="ui basic buttons" id="disp-btns">
                                <div class="ui button active" id="disp-pos-btn">Positions</div>
                                <div class="ui button" id="disp-trade-stock-btn">Trades (By Stock)</div>
                                <div class="ui button" id="disp-trade-date-btn">Trades (By Date)</div>
                            </div>
                        </div>    
                        <div class="four wide field">
                            <select class="ui fluid dropdown" id="stock-selector">
                            </select>
                        </div>
                    </div>
                </form>
            </div>            
            <!-- <div class="column" id="result-container">
            </div>             -->
        </div>

        <div class="ui one column grid" id="output-grid">
        </div>
        
    </div>

    <div class="ui inverted vertical footer segment">
        <div class="ui center aligned container">
            <div class="ui horizontal inverted small divided link list">
                <a class="item" href="http://immetra.com">Copyright &copy; <script>document.write(new Date().getFullYear());</script> Immetra Technologies &mdash; http://immetra.com</a>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js"
        integrity="sha256-pasqAKBDmFT4eHoN2ndd6lN370kFiGUFyTiUHWhU7k8=" crossorigin="anonymous"></script>

    <script>
        $(function () {
            window.filterStock = "";

            function getTrades() {
                var data = JSON.parse(localStorage.getItem("DBD__TRADES"));
                if (data) {
                    var stockNames = [];                    
                    data.forEach(function(d) {
                        d.date = new Date(d.date);
                        stockNames.push(d.stockName);
                    })
                    data.sort(tradeSortFunc);
                    updateStockSelector(stockNames);

                    if (window.filterStock)
                        return data.filter(function(d) { return d.stockName == window.filterStock })
                    else
                        return data;
                } else {
                    window.filterStock = "";
                    updateStockSelector([]);
                    return [];
                }
            }

            function setTrades(trades) {
                localStorage.setItem("DBD__TRADES", JSON.stringify(trades));
            }

            function process() {
                var lines = $("#input-txt").val().split(/\r?\n/);

                var trades = getTrades();
                lines.forEach(function (line) {
                    if (line && line.match(/.*\d\d\/\d\d\/\d{4}.+/)) {
                        var trade = createTrade(line);
                        trades.push(trade);
                    }
                });

                setTrades(trades);
                displayPositions();
            }

            function displayPositions() {
                var openPos = [];
                var closedPos = [];                
                var trades = getTrades();

                trades.forEach(function (trade) {
                    var idx = openPos.findIndex(function(p) { return p.stockName == trade.stockName && p.isClosed == false });
                    var pos = null;
                    if (idx >= 0) {
                        pos = openPos[idx];                        
                    } else {
                        pos = new Position(trade.stockName);
                        openPos.push(pos);
                        idx = openPos.length - 1;
                    }

                    var newClosed = pos.addTrade(trade);

                    if (newClosed) {
                                                closedPos.push(newClosed);
                    } else if (pos.isClosed) {
                        openPos.splice(idx, 1);
                        closedPos.push(pos);
                    }
                });

                //
                // Closed positions
                //
                var totalProfit = 0.0;
                var totalWin = 0;
                var totalLose = 0;

                var htmlClosed = '<div class="column"><h4 class="ui top attached block header">Closed Positions</h4>'
                            + '<table class="ui bottom attached compact table">'
                            + '    <thead><tr><th>Sell Date</th><th>Stock</th><th>Qty</th><th>Avg Buy</th><th>Avg Sell</th><th>Net Buy</th><th>Net Sell</th><th>Profit/Loss</th></tr><thead>'
                            + '    <tbody>';

                closedPos.forEach(function(pos) {                    
                    htmlClosed += '<tr>'
                        + '<td>' + formatDate(pos.lastTradeOn) + '</td>'
                        + '<td>' + pos.stockName + '</td>'
                        + '<td class="ui right aligned">' + (pos.unitCount) + '</td>'
                        + '<td class="ui right aligned">' + formatPrice(pos.avgBuy) + '</td>'
                        + '<td class="ui right aligned">' + formatPrice(pos.avgSell) + '</td>'
                        + '<td class="ui right aligned">' + formatMoney(pos.netBuy) + '</td>'
                        + '<td class="ui right aligned">' + formatMoney(pos.netSell) + '</td>'
                        + '<td class="ui right aligned ' + (pos.profit > 0 ? 'green' : 'red') + '">' + formatMoney(pos.profit) + '</td>'
                        + '</tr>'

                    totalProfit += pos.profit;
                    if (pos.profit > 0) 
                        totalWin++; 
                    else 
                        totalLose++;
                });                
                htmlClosed += '</tbody></table></div>';
                
                //
                // Open positions
                //
                var htmlOpen = '<div class="column"><h4 class="ui top attached block header">Open Positions</h4>'
                        + '<table class="ui bottom attached compact table">'
                        + '    <thead><tr><th>Sell Date</th><th>Stock</th><th>Qty</th><th>Avg Buy</th><th>Avg Sell</th><th>Net Buy</th><th>Net Sell</th><th>Profit/Loss</th></tr><thead>'
                        + '    <tbody>';
                                
                openPos.forEach(function(pos) {
                    htmlOpen += '<tr>'
                        + '<td>' + formatDate(pos.lastTradeOn) + '</td>'
                        + '<td>' + pos.stockName + '</td>'
                        + '<td class="ui right aligned">' + (pos.unitCount) + '</td>'
                        + '<td class="ui right aligned">' + formatPrice(pos.avgBuy) + '</td>'
                        + '<td class="ui right aligned">-</td>'
                        + '<td class="ui right aligned">' + formatMoney(pos.netBuy) + '</td>'
                        + '<td class="ui right aligned">-</td>'
                        + '<td class="ui right aligned">-</td>'
                        + '</tr>'
                });
                    
                htmlOpen += '</tbody></table></div>';
                
                var htmlSummary = '<div class="column"><h4 class="ui top attached block header">Summary</h4>'
                        + '<table class="ui bottom attached compact table">'
                        + '    <thead><tr><th class="ui center aligned">Winning Rate</th><th class="ui center aligned">Total Profit / Loss</th></tr><thead>'
                        + '    <tbody>'
                        + '<tr>'
                        + '<td class="ui center aligned ' + (totalWin > totalLose ? 'green' : 'red') + '">' + totalWin + ' : ' + totalLose + '</td>'
                        + '<td class="ui center aligned ' + (totalProfit > 0 ? 'green' : 'red') + '">' + formatMoney(totalProfit) + '</td>'
                        + '</tr>'
                        + '</tbody></table></div>';

                var html = htmlSummary + htmlClosed + htmlOpen + '<div class="column"></div>';
                $("#output-grid").html(html);
                selectDisplayButton("disp-pos-btn");
            }

            function displayTradesByStock() {
                displayTradesBy(
                    function(trade) { return trade.stockName },
                    function(group) { return group.groupBy },
                );
                selectDisplayButton("disp-trade-stock-btn");
            }

            function displayTradesByDate() {
                displayTradesBy(
                    function(trade) { return trade.date },
                    function(group) { return formatDate(group.groupBy) },
                );
                selectDisplayButton("disp-trade-date-btn");
            }

            function displayTradesBy(groupByFn, headerFormatFunc) {
                var groups = {};
                var trades = getTrades();

                console.log(trades);

                trades.forEach(function (trade) {
                    var groupBy = groupByFn(trade);
                    console.log(groupBy);

                    var grp = groups[groupBy];
                    if (!grp) {
                        grp = new TradeGroup(groupBy);
                        groups[groupBy] = grp;
                    }
                    grp.addTrade(trade);
                });

                var html = "";

                var totalProfit = 0.0;

                var groupKeys = Object.keys(groups);
                if (groupKeys) {
                    groupKeys.sort();
                    groupKeys.forEach(function (groupBy) {
                        var grp = groups[groupBy];
                        
                        totalProfit += grp.profit;

                        html += '<div class="column"><h4 class="ui top attached block header">' + headerFormatFunc(grp) + '</h4>'
                                + '<table class="ui bottom attached compact table">'
                                + '  <thead><tr>'                                    
                                + '    <th>Date</th>'
                                + '    <th>Stock</th>'
                                + '    <th>Type</th>'
                                + '    <th>Quantity</th>'
                                + '    <th>Price</th>'
                                + '    <th>Fees</th>'
                                + '    <th>Net</th></tr></thead><tbody>';
                                
                        grp.trades.forEach(function (trade) {
                            html += '<tr>'
                                + '  <td>' + formatDate(trade.date) + '</td>'
                                + '  <td>' + trade.stockName + '</td>'
                                + '  <td title="' + trade.refNo + '">' + trade.type + '</td>'
                                + '  <td>' + trade.unitCount + '</td>'
                                + '  <td class="ui right aligned">' + formatMoney(trade.price) + '</td>'
                                + '  <td class="ui right aligned">' + formatMoney(trade.feeTotal)
                                + '  <td class="ui right aligned">' + formatMoney(trade.netAmount) + '</td></tr>'
                        });

                        html += '<tfoot><tr><td colspan="6" class="ui right aligned">Profit / Loss</td><td class="ui right aligned ' + (grp.profit > 0 ? 'green' : 'red') + '">' + formatMoney(grp.profit) + '</td><tr></tfoot>';
                            
                        html += '</tbody></table></div>';
                    })
                }

                $("#output-grid").html(html + '<div class="column"></div>');
            }
            
            function exportData() {
                var str = "date\tstockCode\tstockName\ttype\trefNo\tunitCount\tprice\tbrokerageFee\tstampingFee\tclearingFee\tsst\tnetAmount\n"
                getTrades().forEach(function (t) {
                    str += formatDate(t.date) + "\t" 
                            + t.stockCode + "\t" 
                            + t.stockName + "\t" 
                            + t.type + "\t" 
                            + t.refNo + "\t" 
                            + t.unitCount + "\t" 
                            + t.price + "\t" 
                            + t.brokerageFee + "\t" 
                            + t.stampingFee + "\t" 
                            + t.clearingFee + "\t" 
                            + t.sst + "\t" 
                            + t.netAmount + "\n"
                });
                return str; 
            }

            function Position(stockName) {
                this.stockName = stockName;
                this.trades = [];
                
                this.unitCount = 0;
                this.avgBuy = 0.0;
                this.avgSell = 0.0;
                this.netBuy = 0.0;
                this.netSell = 0.0;
                this.profit = 0.0;
                this.lastTradeOn = null;
                this.isClosed = false;                

                this.addTrade = function (trade) {

                    
                    this.lastTradeOn = trade.date;
                    if (trade.type == "Buy") {
                        this.unitCount += trade.unitCount;      
                        this.netBuy += trade.netAmount;                  
                        this.avgBuy = this.netBuy / this.unitCount;
                    } else {
                        if (trade.unitCount > this.unitCount) {
                                                        return;
                        }
                        var unitBalance = this.unitCount - trade.unitCount;
                        if (unitBalance > 0) {
                            // Selling partially. Create another closed position.
                            var closedPos = new Position(this.stockName);
                            closedPos.lastTradeOn = this.lastTradeOn;
                            closedPos.avgBuy = this.avgBuy;
                            closedPos.unitCount = trade.unitCount;
                            closedPos.netBuy = closedPos.unitCount * closedPos.avgBuy;

                            closedPos.avgSell = trade.price;
                            closedPos.netSell = trade.netAmount;
                            closedPos.profit = closedPos.netSell - closedPos.netBuy;
                            closedPos.isClosed = true;

                            this.unitCount = unitBalance;
                            this.netBuy = this.unitCount * this.avgBuy;

                            return closedPos;
                        }

                        this.avgSell = trade.price;
                        this.netSell = trade.netAmount;
                        this.profit = this.netSell - this.netBuy;
                        this.isClosed = true;
                    }
                }
            }

            function TradeGroup(groupBy) {
                this.groupBy = groupBy;
                this.trades = [];                
                this.profit = 0.0;
                
                this.addTrade = function (trade) {
                    this.trades.push(trade);
                    this.trades.sort(tradeSortFunc);
                    
                    var profit = 0.0;
                    this.trades.forEach(function (trade) {
                        if (trade.type == "Buy") {
                            profit -= trade.netAmount;
                        } else {
                            profit += trade.netAmount;
                        }
                    });
                    this.profit = profit;
                }
            }

            function createTrade(str) {
                var m = str.match(/.*(\d\d\/\d\d\/\d{4})\s+(\w+)\s+([^\s]+)\s+(\w+)\s+(\w+)\s+([,\d]+)\s+([\.\d]+)\s+([\.\d]+)\s+([\.\d]+)\s+([\.\d]+)\s+([\.\d]+)\s+([\,\.\d]+).*/);
                console.log(m);
                var mDate = m[1].match(/(\d\d)\/(\d\d)\/(\d{4})/);
                
                var obj = {
                    date: new Date(mDate[3], parseInt(mDate[2]) - 1, mDate[1]),
                    stockCode: m[2],
                    stockName: m[3],
                    type: (m[4] == "Sell" ? "Sell" : "Buy"),
                    refNo: m[5],
                    unitCount: convertInt(m[6]),
                    price: convertFloat(m[7]),
                    brokerageFee: convertFloat(m[8]),
                    stampingFee: convertFloat(m[9]),
                    clearingFee: convertFloat(m[10]),
                    sst: convertFloat(m[11]),
                    netAmount: convertFloat(m[12]),
                }

                obj.lotCount = obj.unitCount / 100;
                obj.feeTotal = obj.brokerageFee + obj.stampingFee + obj.clearingFee + obj.sst;

                return obj;
            }

            function getTradeSortKey(trade) {
                year = trade.date.getFullYear();
                month = trade.date.getMonth() + 1;
                dt = trade.date.getDate();
                if (dt < 10) { dt = '0' + dt; }
                if (month < 10) { month = '0' + month; }
                
                var key = "" + year + month + dt + trade.type;
                // console.log(year, month, dt, key);
                // if (key == "2062Buy") console.log(trade);
                return key;
            }

            function tradeSortFunc(a, b) {
                return getTradeSortKey(a).localeCompare(getTradeSortKey(b));
            }

            function convertInt(str) {
                return convertNum(str, parseInt);
            }

            function convertFloat(str) {
                return convertNum(str, parseFloat);
            }

            function convertNum(str, fn) {
                if (str) {
                    return fn(str.replace(",", ""));
                }
                return 0;
            }

            function formatDate(val) {
                year = val.getFullYear();
                month = val.getMonth() + 1;
                dt = val.getDate();
                if (dt < 10) { dt = '0' + dt; }
                if (month < 10) { month = '0' + month; }
                return dt + "/" + month + "/" + year;
            }

            function formatPrice(val) {
                return val.toFixed(3).toString();
            }

            function formatMoney(val) {
                return val.toFixed(2).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            }

            function toggleInput() {
                $("#input-form").toggle();
                $("#btn-container").toggle();
            };

            function toggleExport() {
                $("#export-form").toggle();
                $("#btn-container").toggle();
            };

            function updateStockSelector(stockNames) {
                var el = $("#stock-selector");
                el.empty();
                el.append('<option value="">All</option>');
                if (stockNames) {
                    var names = stockNames.filter(function (x, i, a) { return a.indexOf(x) == i; });
                    names.sort();
                    names.forEach(function(stock) {
                        el.append('<option value="' + stock + '">' + stock + '</option>');                    
                    });
                }
                el.val(window.filterStock);
            }

            $("#input-btn").click(function () {
                $("#input-txt").val("");
                toggleInput();
            });

            $("#process-btn").click(function () {
                toggleInput();
                process();
            });

            $("#cancel-btn").click(toggleInput);

            $("#clear-btn").click(function () {
                if (confirm("Are you sure to clear all data?")) {
                    setTrades([]);
                    $("#output-grid").html("");
                }
            });

            $("#export-btn").click(function(){
                $("#export-txt").val(exportData());
                toggleExport();
            });

            $("#export-close-btn").click(toggleExport);

            function selectDisplayButton(btnId) {
                $("#disp-btns .button").removeClass("active");
                $("#" + btnId).addClass("active");
            }

            $("#disp-btns .button").click(function(e) {
                var id = $(e.currentTarget).attr("id");
                switch (id) {
                    case "disp-pos-btn": displayPositions(); break;
                    case "disp-trade-stock-btn": displayTradesByStock(); break;
                    case "disp-trade-date-btn": displayTradesByDate(); break;
                }
            })

            $("#stock-selector").change(function(e) {
                var el = $(e.currentTarget);
                window.filterStock = el.val();           
                displayPositions();
            })

            // Startup
            displayPositions();
        });
    </script>
</body>

</html>